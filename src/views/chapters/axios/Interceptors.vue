<template>
  <div class="knowledge-page">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-header">
      <h1>æ‹¦æˆªå™¨</h1>
      <p class="subtitle">åœ¨è¯·æ±‚å‘é€å‰å’Œå“åº”è¿”å›åè¿›è¡Œç»Ÿä¸€å¤„ç†</p>
    </div>

    <!-- æ¦‚å¿µè¯´æ˜ -->
    <KnowledgeCard title="ğŸ“– æ¦‚å¿µè¯´æ˜">
      <p><strong>æ‹¦æˆªå™¨</strong>å¯ä»¥åœ¨è¯·æ±‚å‘é€å‰æˆ–å“åº”è¿”å›åï¼Œå¯¹æ•°æ®è¿›è¡Œç»Ÿä¸€å¤„ç†ã€‚</p>
      
      <div class="analogy-box">
        <h4>ğŸ­ é€šä¿—æ¯”å–»</h4>
        <p>æ‹¦æˆªå™¨å°±åƒæœºåœºçš„å®‰æ£€ï¼š</p>
        <ul>
          <li><strong>è¯·æ±‚æ‹¦æˆªå™¨</strong> = å‡ºå‘å®‰æ£€ï¼šæ£€æŸ¥è¯ä»¶ã€æ·»åŠ è¡Œææ ‡ç­¾</li>
          <li><strong>å“åº”æ‹¦æˆªå™¨</strong> = åˆ°è¾¾æ£€æŸ¥ï¼šæ£€æŸ¥åŒ…è£¹ã€å¤„ç†å¼‚å¸¸æƒ…å†µ</li>
        </ul>
      </div>
    </KnowledgeCard>

    <!-- æ‹¦æˆªå™¨æµç¨‹ -->
    <KnowledgeCard title="ğŸ”„ æ‹¦æˆªå™¨æ‰§è¡Œæµç¨‹">
      <div class="flow-diagram">
        <div class="flow-item">ğŸ“¤ å‘é€è¯·æ±‚</div>
        <div class="flow-arrow">â†“</div>
        <div class="flow-item highlight">ğŸ”’ è¯·æ±‚æ‹¦æˆªå™¨</div>
        <div class="flow-arrow">â†“</div>
        <div class="flow-item">ğŸŒ æœåŠ¡å™¨å¤„ç†</div>
        <div class="flow-arrow">â†“</div>
        <div class="flow-item highlight">ğŸ”“ å“åº”æ‹¦æˆªå™¨</div>
        <div class="flow-arrow">â†“</div>
        <div class="flow-item">âœ… è¿”å›ç»“æœ</div>
      </div>
    </KnowledgeCard>

    <!-- è¯·æ±‚æ‹¦æˆªå™¨ -->
    <KnowledgeCard title="ğŸ“¤ è¯·æ±‚æ‹¦æˆªå™¨">
      <p>åœ¨è¯·æ±‚å‘é€å‰æ‰§è¡Œï¼Œå¸¸ç”¨äºï¼š</p>
      <ul>
        <li>æ·»åŠ è®¤è¯ Token</li>
        <li>æ·»åŠ å…¬å…±è¯·æ±‚å¤´</li>
        <li>æ˜¾ç¤º loading çŠ¶æ€</li>
        <li>è¯·æ±‚æ•°æ®æ ¼å¼åŒ–</li>
      </ul>
      <CodeBlock :code="requestInterceptorCode" language="javascript" />
    </KnowledgeCard>

    <!-- Demo 1: è¯·æ±‚æ‹¦æˆªå™¨ -->
    <KnowledgeCard title="ğŸ¯ Demo 1: è¯·æ±‚æ‹¦æˆªå™¨ - æ·»åŠ  Token">
      <p>è‡ªåŠ¨ä¸ºæ¯ä¸ªè¯·æ±‚æ·»åŠ è®¤è¯ Tokenï¼š</p>
      <DemoBox 
        demoPath="axios/interceptor-request"
        title="è¯·æ±‚æ‹¦æˆªå™¨æ¼”ç¤º"
        height="400px"
      />
    </KnowledgeCard>

    <!-- å“åº”æ‹¦æˆªå™¨ -->
    <KnowledgeCard title="ğŸ“¥ å“åº”æ‹¦æˆªå™¨">
      <p>åœ¨å“åº”è¿”å›åæ‰§è¡Œï¼Œå¸¸ç”¨äºï¼š</p>
      <ul>
        <li>ç»Ÿä¸€å¤„ç†å“åº”æ•°æ®æ ¼å¼</li>
        <li>ç»Ÿä¸€é”™è¯¯å¤„ç†</li>
        <li>å…³é—­ loading çŠ¶æ€</li>
        <li>Token è¿‡æœŸè‡ªåŠ¨åˆ·æ–°</li>
      </ul>
      <CodeBlock :code="responseInterceptorCode" language="javascript" />
    </KnowledgeCard>

    <!-- Demo 2: å“åº”æ‹¦æˆªå™¨ -->
    <KnowledgeCard title="ğŸ¯ Demo 2: å“åº”æ‹¦æˆªå™¨ - ç»Ÿä¸€å¤„ç†">
      <p>ç»Ÿä¸€å¤„ç†å“åº”æ ¼å¼å’Œé”™è¯¯ï¼š</p>
      <DemoBox 
        demoPath="axios/interceptor-response"
        title="å“åº”æ‹¦æˆªå™¨æ¼”ç¤º"
        height="420px"
      />
    </KnowledgeCard>

    <!-- Demo 3: Loading çŠ¶æ€ -->
    <KnowledgeCard title="ğŸ¯ Demo 3: å…¨å±€ Loading çŠ¶æ€">
      <p>ä½¿ç”¨æ‹¦æˆªå™¨è‡ªåŠ¨ç®¡ç† loading çŠ¶æ€ï¼š</p>
      <DemoBox 
        demoPath="axios/interceptor-loading"
        title="Loading çŠ¶æ€ç®¡ç†"
        height="380px"
      />
    </KnowledgeCard>

    <!-- Demo 4: ç§»é™¤æ‹¦æˆªå™¨ -->
    <KnowledgeCard title="ğŸ¯ Demo 4: ç§»é™¤æ‹¦æˆªå™¨">
      <p>åŠ¨æ€æ·»åŠ å’Œç§»é™¤æ‹¦æˆªå™¨ï¼š</p>
      <DemoBox 
        demoPath="axios/interceptor-eject"
        title="ç§»é™¤æ‹¦æˆªå™¨"
        height="400px"
      />
    </KnowledgeCard>

    <!-- Demo 5: å¤šä¸ªæ‹¦æˆªå™¨ -->
    <KnowledgeCard title="ğŸ¯ Demo 5: å¤šä¸ªæ‹¦æˆªå™¨æ‰§è¡Œé¡ºåº">
      <p>ç†è§£å¤šä¸ªæ‹¦æˆªå™¨çš„æ‰§è¡Œé¡ºåºï¼š</p>
      <DemoBox 
        demoPath="axios/interceptor-order"
        title="æ‹¦æˆªå™¨æ‰§è¡Œé¡ºåº"
        height="420px"
      />
    </KnowledgeCard>

    <!-- æ‰§è¡Œé¡ºåºè¯´æ˜ -->
    <KnowledgeCard title="ğŸ“‹ å¤šä¸ªæ‹¦æˆªå™¨æ‰§è¡Œé¡ºåº">
      <table class="info-table">
        <thead>
          <tr>
            <th>ç±»å‹</th>
            <th>æ‰§è¡Œé¡ºåº</th>
            <th>è¯´æ˜</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>è¯·æ±‚æ‹¦æˆªå™¨</td>
            <td>åæ·»åŠ å…ˆæ‰§è¡Œ</td>
            <td>ç±»ä¼¼æ ˆç»“æ„ï¼ˆLIFOï¼‰</td>
          </tr>
          <tr>
            <td>å“åº”æ‹¦æˆªå™¨</td>
            <td>å…ˆæ·»åŠ å…ˆæ‰§è¡Œ</td>
            <td>ç±»ä¼¼é˜Ÿåˆ—ç»“æ„ï¼ˆFIFOï¼‰</td>
          </tr>
        </tbody>
      </table>
    </KnowledgeCard>

    <!-- æœ€ä½³å®è·µ -->
    <TipBox type="success" title="âœ… æœ€ä½³å®è·µ">
      <ol>
        <li><strong>è¯·æ±‚æ‹¦æˆªå™¨æ·»åŠ  Token</strong>ï¼šç»Ÿä¸€å¤„ç†è®¤è¯</li>
        <li><strong>å“åº”æ‹¦æˆªå™¨è§£åŒ… data</strong>ï¼šç›´æ¥è¿”å› response.data</li>
        <li><strong>ç»Ÿä¸€é”™è¯¯å¤„ç†</strong>ï¼šæ ¹æ®çŠ¶æ€ç æ˜¾ç¤ºä¸åŒæç¤º</li>
        <li><strong>Loading çŠ¶æ€ç®¡ç†</strong>ï¼šé…åˆ Vuex ä½¿ç”¨</li>
        <li><strong>Token è¿‡æœŸè‡ªåŠ¨åˆ·æ–°</strong>ï¼š401 æ—¶åˆ·æ–° token é‡è¯•</li>
      </ol>
    </TipBox>

    <!-- å¸¸è§é”™è¯¯ -->
    <TipBox type="error" title="âŒ å¸¸è§é”™è¯¯">
      <div class="error-example">
        <p><strong>é”™è¯¯ï¼šå¿˜è®°è¿”å› config æˆ– response</strong></p>
        <CodeBlock :code="errorExample" language="javascript" />
        <p><strong>æ­£ç¡®ï¼šå¿…é¡»è¿”å›å¤„ç†åçš„ config æˆ– response</strong></p>
        <CodeBlock :code="correctExample" language="javascript" />
      </div>
    </TipBox>
  </div>
</template>

<script>
import KnowledgeCard from '@/components/content/KnowledgeCard.vue'
import TipBox from '@/components/content/TipBox.vue'
import CodeBlock from '@/components/demo/CodeBlock.vue'
import DemoBox from '@/components/demo/DemoBox.vue'
import scrollTrackingMixin from '@/utils/scrollTrackingMixin'

export default {
  name: 'AxiosInterceptors',
  
  mixins: [scrollTrackingMixin],
  
  components: {
    KnowledgeCard,
    TipBox,
    CodeBlock,
    DemoBox
  },
  
  data() {
    return {
      requestInterceptorCode: `// è¯·æ±‚æ‹¦æˆªå™¨
axios.interceptors.request.use(
  config => {
    // âœ… åœ¨è¯·æ±‚å‘é€å‰åšäº›ä»€ä¹ˆ
    
    // 1. æ·»åŠ  Token
    const token = localStorage.getItem('token')
    if (token) {
      config.headers.Authorization = \`Bearer \${token}\`
    }
    
    // 2. æ˜¾ç¤º loading
    store.commit('SET_LOADING', true)
    
    // å¿…é¡»è¿”å› config
    return config
  },
  error => {
    // âŒ è¯·æ±‚é”™è¯¯å¤„ç†
    return Promise.reject(error)
  }
)`,

      responseInterceptorCode: `// å“åº”æ‹¦æˆªå™¨
axios.interceptors.response.use(
  response => {
    // âœ… å“åº”æˆåŠŸå¤„ç†
    
    // 1. å…³é—­ loading
    store.commit('SET_LOADING', false)
    
    // 2. ç›´æ¥è¿”å› data
    return response.data
  },
  error => {
    // âŒ å“åº”é”™è¯¯å¤„ç†
    store.commit('SET_LOADING', false)
    
    if (error.response) {
      switch (error.response.status) {
        case 401:
          // Token è¿‡æœŸï¼Œè·³è½¬ç™»å½•
          router.push('/login')
          break
        case 403:
          alert('æ²¡æœ‰æƒé™')
          break
        case 500:
          alert('æœåŠ¡å™¨é”™è¯¯')
          break
      }
    }
    
    return Promise.reject(error)
  }
)`,

      errorExample: `// âŒ é”™è¯¯ï¼šæ²¡æœ‰è¿”å› config
axios.interceptors.request.use(config => {
  config.headers.Token = 'xxx'
  // å¿˜è®° return config ä¼šå¯¼è‡´è¯·æ±‚å¤±è´¥ï¼
})`,

      correctExample: `// âœ… æ­£ç¡®ï¼šå¿…é¡»è¿”å› config
axios.interceptors.request.use(config => {
  config.headers.Token = 'xxx'
  return config  // å¿…é¡»è¿”å›ï¼
})`
    }
  }
}
</script>

<style lang="scss" scoped>
.knowledge-page {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
}

.page-header {
  text-align: center;
  margin-bottom: 32px;
  
  h1 {
    font-size: 28px;
    color: #1d1d1f;
    margin-bottom: 8px;
  }
  
  .subtitle {
    color: #86868b;
    font-size: 16px;
  }
}

.analogy-box {
  background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
  padding: 16px;
  border-radius: 8px;
  margin-top: 16px;
  
  h4 {
    margin-bottom: 8px;
    color: #9d174d;
  }
  
  p, ul {
    color: #831843;
    font-size: 14px;
  }
  
  ul {
    padding-left: 20px;
    margin-top: 8px;
  }
}

.flow-diagram {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
  background: #f9fafb;
  border-radius: 8px;
  
  .flow-item {
    padding: 12px 24px;
    background: white;
    border: 2px solid #e5e5ea;
    border-radius: 8px;
    font-weight: 500;
    
    &.highlight {
      background: #dbeafe;
      border-color: #3b82f6;
      color: #1e40af;
    }
  }
  
  .flow-arrow {
    padding: 8px;
    color: #86868b;
    font-size: 18px;
  }
}

.info-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  
  th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e5e5ea;
  }
  
  th {
    background: #f5f5f7;
    font-weight: 600;
    color: #1d1d1f;
  }
}

.error-example {
  p {
    font-size: 14px;
    margin: 12px 0 8px;
  }
}
</style>
